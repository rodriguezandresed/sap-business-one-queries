SELECT TOTALES.CLIENTE AS "CLIENTE", TOTALES.PRODUCTO AS "PRODUCTO", SUM(TOTALES.RESULTADO) AS "TOTAL VENDIDO" FROM
((SELECT CASE 
WHEN (QUOTE.RUTA  IS NULL) AND (DEVOLUCION.RUTA IS NULL) THEN INVOICE.RUTA
WHEN (INVOICE.RUTA IS NULL) AND (DEVOLUCION.RUTA IS NULL) THEN  QUOTE.RUTA
WHEN (INVOICE.RUTA IS NULL) AND (QUOTE.RUTA IS NULL) THEN  DEVOLUCION.RUTA
ELSE INVOICE.RUTA
END AS 'RUTA',
CASE 
WHEN QUOTE.CLIENTE  IS NULL AND DEVOLUCION.CLIENTE IS NULL THEN INVOICE.CLIENTE
WHEN INVOICE.CLIENTE IS NULL AND DEVOLUCION.CLIENTE IS NULL THEN  QUOTE.CLIENTE
WHEN (INVOICE.CLIENTE IS NULL) AND (QUOTE.CLIENTE IS NULL) THEN  DEVOLUCION.CLIENTE
ELSE INVOICE.CLIENTE
END AS 'CLIENTE',
CASE 
WHEN QUOTE.PRODUCTO  IS NULL AND DEVOLUCION.PRODUCTO IS NULL THEN INVOICE.PRODUCTO
WHEN INVOICE.PRODUCTO IS NULL AND DEVOLUCION.PRODUCTO IS NULL THEN  QUOTE.PRODUCTO
WHEN (INVOICE.PRODUCTO IS NULL) AND (QUOTE.PRODUCTO IS NULL) THEN  DEVOLUCION.PRODUCTO
ELSE INVOICE.PRODUCTO
END AS 'PRODUCTO',

CASE 
WHEN QUOTE.RESULTADO IS NULL THEN COALESCE(INVOICE.RESULTADO,0)-COALESCE(DEVOLUCION.RESULTADO,0)
WHEN INVOICE.RESULTADO IS NULL  THEN COALESCE(QUOTE.RESULTADO,0)-COALESCE(DEVOLUCION.RESULTADO,0)
WHEN QUOTE.RESULTADO IS NULL AND INVOICE.RESULTADO IS NULL THEN 0 
ELSE COALESCE(QUOTE.RESULTADO,0)+COALESCE(INVOICE.RESULTADO,0)-COALESCE(DEVOLUCION.RESULTADO,0)
END AS "RESULTADO" 
FROM ( 

(SELECT T0.[U_ORN_RUTAS_VENTAS] AS 'RUTA', T1.[ItemCode] AS 'PRODUCTO', SUM(T1.[Quantity]) AS 'RESULTADO', T0.[CardName] as 'CLIENTE'
FROM OQUT T0  INNER JOIN QUT1 T1 ON T0.[DocEntry] = T1.[DocEntry]  WHERE (T0.[DocDate] BETWEEN [%0] AND [%1]) AND (T0."CANCELED" = 'N') AND (T0."DocStatus" = 'O' ) and T0.[CardName] NOT in ('FARMATODO,C.A.') AND T1.Quantity>0 
AND T0.[CardName] = [%2] GROUP BY T0.[U_ORN_RUTAS_VENTAS], T1.[ItemCode] ,   T0.[CardName]) AS QUOTE 

FULL OUTER JOIN 

(SELECT T0.[U_ORN_RUTAS_VENTAS] AS 'RUTA', T1.[ItemCode] AS 'PRODUCTO', SUM(T1.[Quantity]) AS 'RESULTADO', T0.[CardName] as 'CLIENTE'
FROM OINV T0  INNER JOIN INV1 T1 ON T0.[DocEntry] = T1.[DocEntry]  WHERE (T0.[DocDate] BETWEEN [%0] AND [%1])  and T0.[CardName] NOT in ('FARMATODO,C.A.')  AND T1.Quantity>0 AND T0.[CardName] = [%2]   GROUP BY T0.[U_ORN_RUTAS_VENTAS] , T1.[ItemCode] ,   T0.[CardName] ) AS  INVOICE ON QUOTE.RUTA = INVOICE.RUTA AND QUOTE.PRODUCTO = INVOICE.PRODUCTO
 
 FULL OUTER JOIN

(SELECT T0.[U_ORN_RUTAS_VENTAS] AS 'RUTA',  T1.[ItemCode] AS 'PRODUCTO', SUM(T1.[Quantity]) AS 'RESULTADO', T0.[CardName] as 'CLIENTE'
FROM ORIN T0  INNER JOIN RIN1 T1 ON T0.[DocEntry] = T1.[DocEntry]  
WHERE T0.[DocDate] BETWEEN [%0] AND [%1] and  T0.[CardName] = [%2]  and T0.[CardName] NOT in ('FARMATODO,C.A.')  and T1.[Quantity]>0
GROUP BY T0.[U_ORN_RUTAS_VENTAS] , T1.[ItemCode],   T0.[CardName]) AS  DEVOLUCION  ON  INVOICE.RUTA = DEVOLUCION.RUTA AND INVOICE.PRODUCTO = DEVOLUCION.PRODUCTO) )

UNION ALL

(SELECT CASE 
WHEN QUOTEFARMASUM.RUTA  IS NULL THEN INVOICEFARMASUM.RUTA ELSE QUOTEFARMASUM.RUTA
END AS 'Ruta de Ventas',
CASE 
WHEN QUOTEFARMASUM.CLIENTE  IS NULL THEN INVOICEFARMASUM.CLIENTE ELSE QUOTEFARMASUM.CLIENTE
END AS 'CLIENTE',
CASE 
WHEN QUOTEFARMASUM.PRODUCTO  IS NULL THEN INVOICEFARMASUM.PRODUCTO ELSE QUOTEFARMASUM.PRODUCTO
END AS 'Producto',
CASE 
WHEN QUOTEFARMASUM.RUTA IS NULL THEN ROUND(COALESCE(INVOICEFARMASUM.RESULTADO,0)-COALESCE(DEVOLUCIONFARMASUM.RESULTADO,0),0) 
WHEN INVOICEFARMASUM.RUTA IS NULL  THEN ROUND(COALESCE(QUOTEFARMASUM.RESULTADO,0)-COALESCE(DEVOLUCIONFARMASUM.RESULTADO,0),0)  
ELSE ROUND(QUOTEFARMASUM.RESULTADO+INVOICEFARMASUM.RESULTADO-DEVOLUCIONFARMASUM.RESULTADO,0)  
END AS "Resultado de Ventas" 
FROM

(SELECT INVOICEFARMA.RUTA AS 'RUTA', INVOICEFARMA.PRODUCTO AS 'PRODUCTO', SUM(INVOICEFARMA.RESULTADO) AS 'RESULTADO', INVOICEFARMA.CLIENTE AS 'CLIENTE' FROM  (SELECT T0.[U_ORN_RUTAS_VENTAS] AS 'RUTA', T1.[ItemCode] AS 'PRODUCTO', T0.[CardName] as 'CLIENTE',  
CASE WHEN T2.[UgpEntry] = 10 THEN SUM(T1.[Quantity]) / 20 
WHEN T2.[UgpEntry] = 11 THEN SUM(T1.[Quantity]) / 25 
WHEN T2.[UgpEntry] = 12 THEN SUM(T1.[Quantity]) / 50 
END   AS 'RESULTADO' 
FROM OINV T0 INNER JOIN INV1 T1 ON T0.[DocEntry] = T1.[DocEntry] INNER JOIN OITM T2 ON T1.[ItemCode] = T2.[ItemCode] 
WHERE T0.[DocDate] BETWEEN [%0] AND [%1] AND T0.[CardName] = [%2] and [CardName] = 'FARMATODO,C.A.'   AND T1.Quantity>0 
GROUP BY T0.[U_ORN_RUTAS_VENTAS], T1.[ItemCode], T2.[UgpEntry], T0.[CardName]) AS INVOICEFARMA GROUP BY INVOICEFARMA.RUTA, INVOICEFARMA.PRODUCTO , INVOICEFARMA.CLIENTE  ) AS INVOICEFARMASUM

FULL OUTER JOIN 


(SELECT QUOTEFARMA.RUTA AS 'RUTA', QUOTEFARMA.PRODUCTO AS 'PRODUCTO', SUM(QUOTEFARMA.RESULTADO) AS 'RESULTADO' , QUOTEFARMA.CLIENTE AS 'CLIENTE'  FROM   ( SELECT T0.[U_ORN_RUTAS_VENTAS] AS 'RUTA',  T1.[ItemCode] AS 'PRODUCTO', T0.[CardName] as 'CLIENTE',
CASE WHEN T2.[UgpEntry] = 10 THEN SUM(T1.[Quantity]) / 20  
WHEN T2.[UgpEntry] = 11 THEN SUM(T1.[Quantity]) / 25  
WHEN T2.[UgpEntry] = 12 THEN SUM(T1.[Quantity]) / 50 END   AS 'RESULTADO' 
FROM OQUT T0  INNER JOIN QUT1 T1 ON T0.[DocEntry] = T1.[DocEntry] INNER JOIN OITM T2 ON T1.[ItemCode] = T2.[ItemCode] 
WHERE T0.[DocDate] BETWEEN [%0] AND [%1] AND T0.[CardName] = [%2] AND [CardName] = 'FARMATODO,C.A.' and (T0."CANCELED" = 'N') AND(T0."DocStatus" = 'O' ) AND T1.Quantity>0  
GROUP BY T0.[U_ORN_RUTAS_VENTAS],  T1.[ItemCode], T2.[UgpEntry], T0.[CardName]) AS QUOTEFARMA GROUP BY QUOTEFARMA.RUTA, QUOTEFARMA.PRODUCTO , QUOTEFARMA.CLIENTE ) AS QUOTEFARMASUM ON INVOICEFARMASUM.RUTA = QUOTEFARMASUM.RUTA AND INVOICEFARMASUM.PRODUCTO = QUOTEFARMASUM.PRODUCTO


FULL OUTER JOIN 

(SELECT DEVOLUCIONFARMA.RUTA AS 'RUTA', DEVOLUCIONFARMA.PRODUCTO AS 'PRODUCTO', SUM(DEVOLUCIONFARMA.RESULTADO) AS 'RESULTADO' , DEVOLUCIONFARMA.CLIENTE as 'CLIENTE' FROM  (SELECT T0.[U_ORN_RUTAS_VENTAS] AS 'RUTA',  T1.[ItemCode] AS 'PRODUCTO', T0.[CardName] as 'CLIENTE' ,
CASE WHEN T2.[UgpEntry] = 10 THEN SUM(T1.[Quantity]) / 20 
WHEN T2.[UgpEntry] = 11 THEN SUM(T1.[Quantity]) / 25 
WHEN T2.[UgpEntry] = 12 THEN SUM(T1.[Quantity]) / 50 END   AS 'RESULTADO'
FROM ORIN T0  INNER JOIN RIN1 T1 ON T0.[DocEntry] = T1.[DocEntry] INNER JOIN OITM T2 ON T1.[ItemCode] = T2.[ItemCode]  
WHERE T0.[DocDate] BETWEEN [%0] AND [%1] AND T0.[DocDate] >= '2021-01-31' and T0.[CardName] = [%2] AND [CardName] = 'FARMATODO,C.A.'  and T1.[Quantity]>0 
GROUP BY T0.[U_ORN_RUTAS_VENTAS] ,  T1.[ItemCode], T2.[UgpEntry], T0.[CardName] ) AS  DEVOLUCIONFARMA GROUP BY DEVOLUCIONFARMA.RUTA, DEVOLUCIONFARMA.PRODUCTO, DEVOLUCIONFARMA.CLIENTE) AS DEVOLUCIONFARMASUM ON INVOICEFARMASUM.RUTA = DEVOLUCIONFARMASUM.RUTA AND INVOICEFARMASUM.PRODUCTO = DEVOLUCIONFARMASUM.PRODUCTO) ) as TOTALES GROUP BY TOTALES.CLIENTE, TOTALES.PRODUCTO
